#!/bin/sh

dir() {
    echo starting with $1
    cd $1
    git remote update
    LOCAL=$(git rev-parse @)
    REMOTE=$(git rev-parse '@{u}')
    BASE=$(git merge-base @ '@{u}')
    if [ $LOCAL = $REMOTE ]; then
        echo "Sleeping for 100 secs"
        sleep 100
    elif [ $LOCAL = $BASE ]; then
        git pull
        echo "starting build"
        sh ci.sh
        echo "build finished"
    elif [ $REMOTE = $BASE ]; then
        echo "Warning: You have local changes."
    else
        echo "Error: Your local repo is broken."
        exit 1
    fi
    echo so done with $1
}

I=0

while true ; do
    for proj in AmplissimusApp Artillar ; do
            I=$(($I + 1))
            dir ~/$proj 2>&1 | tee -a /usr/local/var/www/log.txt
            if [ $I -gt 10 ] ; then
                    I=0
                    fn=/usr/local/var/www/log_$(date +%Y_%m_%d-%H_%M_%S).txt
                    mv -f /usr/local/var/www/log.txt $fn
                    xz -9 $fn
            fi
    done
done

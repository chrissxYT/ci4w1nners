#!/bin/sh

compressloginbackground() {
    while true ; do
        while [ ! -f /usr/local/var/www/log.txt ] ; do sleep 3 ; done
        fn=/usr/local/var/www/log_$(date +%s).txt
        mv -f /usr/local/var/www/log.txt $fn
        gzip -9 $fn
        sleep 10000
    done
}

dir() {
    echo starting with $1
    cd $1
    git remote update
    LOCAL=$(git rev-parse @)
    REMOTE=$(git rev-parse '@{u}')
    BASE=$(git merge-base @ '@{u}')
    if [ $LOCAL = $REMOTE ]; then
        echo "Sleeping for 100 secs"
        sleep 100
    elif [ $LOCAL = $BASE ]; then
        git pull
        echo "starting build"
        sh ci.sh
        echo "build finished"
    elif [ $REMOTE = $BASE ]; then
        echo "Warning: You have local changes."
    else
        echo "Error: Your local repo is broken."
        exit 1
    fi
    echo so done with $1
}

compressloginbackground &

while true ; do
    for proj in AmplissimusApp Artillar ; do
            dir ~/$proj 2>&1 | tee -a /usr/local/var/www/log.txt
    done
done
